/*
 *  Copyright 2019 KardiaChain
 *  This file is part of the go-kardia library.
 *
 *  The go-kardia library is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  The go-kardia library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License
 *  along with the go-kardia library. If not, see <http://www.gnu.org/licenses/>.
 */

package sample_kvm

import (
	"math/big"
	"strings"
	"testing"

	// "github.com/kardiachain/go-kardia/kai/kaidb/memorydb"

	"github.com/kardiachain/go-kardia/kai/kaidb/memorydb"
	"github.com/kardiachain/go-kardia/kai/state"
	"github.com/kardiachain/go-kardia/kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/log"
)

func TestDefaults(t *testing.T) {
	cfg := new(Config)
	setDefaults(cfg)

	if cfg.Time == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.GasLimit == 0 {
		t.Error("didn't expect gaslimit to be zero")
	}
	if cfg.GasPrice == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.Value == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.GetHashFn == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.BlockHeight != 0 {
		t.Error("expected block height to be 0")
	}
}

func TestKVM(t *testing.T) {
	defer func() {
		if r := recover(); r != nil {
			t.Fatalf("crashed with: %v", r)
		}
	}()

	Execute([]byte{
		byte(kvm.TIMESTAMP),
		byte(kvm.GASLIMIT),
		byte(kvm.PUSH1),
		byte(kvm.ORIGIN),
		byte(kvm.BLOCKHASH),
		byte(kvm.COINBASE),
	}, nil, nil)
}

func TestExecute(t *testing.T) {
	ret, _, err := Execute([]byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	}, nil, nil)
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
}

func TestCall(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, []byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	})

	ret, _, err := Call(address, nil, &Config{State: state})
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
}

// Simple counter smart contract to be used for below tests:
/*
- counter.sol:
	pragma solidity ^0.4.24;
	contract Counter {
    	uint8 count;
    	function set(uint8 x) public {
        	count = x;
    	}
    	function get() public view returns (uint8) {
        	return count;
    	}
	}

- compiler: remix: 0.4.24+commit.e67f0147.Emscripten.clang
*/

// Test creating a simple smart contract on KVM.
// Note: Create uses the raw bytecode as generated from compiler
func TestCreateSimpleCounterSmc(t *testing.T) {
	// Add bytecode for counter.sol to create the smc:
	var input = common.Hex2Bytes("608060405234801561001057600080fd5b5060da8061001f6000396000f30060806040526004361060485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166324b8ba5f8114604d5780636d4ce63c146067575b600080fd5b348015605857600080fd5b50606560ff60043516608f565b005b348015607257600080fd5b50607960a5565b6040805160ff9092168252519081900360200190f35b6000805460ff191660ff92909216919091179055565b60005460ff16905600a165627a7a723058206cc1a54f543612d04d3f16b0bbb49e9ded9ccf6d47f7789fe3577260346ed44d0029")
	_, _, _, err := Create(input, nil)
	if err != nil {
		t.Fatal(err)
	}
}

// Test executing the counter smart contract on KVM
// Note: Call uses the runtime_bytecode from the compiler, unlike the raw bytecode as in the previous unit test
func TestCallSimpleCounterSmc(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	address := common.HexToAddress("0x0a")

	// Add runtime_bytecode for counter.sol to execute the smc:
	var code = common.Hex2Bytes("60806040526004361060485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166324b8ba5f8114604d5780636d4ce63c146067575b600080fd5b348015605857600080fd5b50606560ff60043516608f565b005b348015607257600080fd5b50607960a5565b6040805160ff9092168252519081900360200190f35b6000805460ff191660ff92909216919091179055565b60005460ff16905600a165627a7a723058206cc1a54f543612d04d3f16b0bbb49e9ded9ccf6d47f7789fe3577260346ed44d0029")
	state.SetCode(address, code)
	var definition = `[
		{"constant":false,"inputs":[{"name":"x","type":"uint8"}],"name":"set","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
		{"constant":true,"inputs":[],"name":"get","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"}
	]`

	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	// Sets counter to 5
	set, err := abi.Pack("set", uint8(5))
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = Call(address, set, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	// Gets counter and verifies it is 5
	get, err := abi.Pack("get")
	if err != nil {
		t.Fatal(err)
	}
	result, _, err := Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num := new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(5)) != 0 {
		t.Error("Expected 5, got", num)
	}
}

func TestChangeBalance(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	var address = common.HexToAddress("0x0b")
	state.CreateAccount(address)
	state.AddBalance(address, big.NewInt(500))

	var balance = state.GetBalance(address)
	if balance.Cmp(big.NewInt(500)) != 0 {
		t.Error("error setting balance, expect 500, got", balance)
	}

	state.SubBalance(address, big.NewInt(100))
	balance = state.GetBalance(address)
	if balance.Cmp(big.NewInt(400)) != 0 {
		t.Error("error subtract balance, expect 400, got", balance)
	}
}

func TestCallSmcDeductBalance(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	var sender = common.HexToAddress("0x0b")
	state.CreateAccount(sender)
	state.AddBalance(sender, big.NewInt(500))

	address := common.HexToAddress("0x0a")

	state.SetCode(address, []byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	})
	ret, _, err := Call(address, nil, &Config{State: state, Origin: sender, Value: big.NewInt(50)})
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
	var sender_balance = state.GetBalance(sender)
	if sender_balance.Cmp(big.NewInt(450)) != 0 {
		t.Error("Invalid remaining balance, expect 450, got", sender_balance)
	}
	var contract_balance = state.GetBalance(address)
	if contract_balance.Cmp(big.NewInt(50)) != 0 {
		t.Error("Invalid contract balance, expect 50, got", contract_balance)
	}
}

// This test contains all the test cases for interfaces of the decentralized exchange contract
// Please find the solidity source code at go-kardia/kvm/smc/Exchange.sol
func TestDecentralizedExchangeContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))

	address := common.HexToAddress("0x0a")

	var code = common.Hex2Bytes("60806040526004361061008e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c72bd871461009357806342e11635146101105780634d78b88e146101ce5780637fb06000146102825780638e4a240414610306578063ab2cb4f914610383578063b41f6a7a1461040a578063f2b57a28146105d6575b600080fd5b34801561009f57600080fd5b506100fa600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061072f565b6040518082815260200191505060405180910390f35b34801561011c57600080fd5b50610177600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610880565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156101ba57808201518184015260208101905061019f565b505050509050019250505060405180910390f35b3480156101da57600080fd5b506101f9600480360381019080803590602001909291905050506109ec565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561024557808201518184015260208101905061022a565b50505050905090810190601f1680156102725780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b34801561028e57600080fd5b506102e9600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610ca0565b604051808381526020018281526020019250505060405180910390f35b34801561031257600080fd5b50610381600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919080359060200190929190505050610d8a565b005b34801561038f57600080fd5b506103f460048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610e26565b6040518082815260200191505060405180910390f35b34801561041657600080fd5b5061054d600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919050505061133a565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561059957808201518184015260208101905061057e565b50505050905090810190601f1680156105c65780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156105e257600080fd5b50610719600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506118dc565b6040518082815260200191505060405180910390f35b6000606060008092506001846040518082805190602001908083835b602083101515610770578051825260208201915060208101905060208303925061074b565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156107ed57602002820191906000526020600020905b8154815260200190600101908083116107d9575b50505050509150600090505b8151811015610876576000806000848481518110151561081557fe5b90602001906020020151815260200190815260200160002060050154141561086957600080838381518110151561084857fe5b90602001906020020151815260200190815260200160002060040154830192505b80806001019150506107f9565b8292505050919050565b60608060006001846040518082805190602001908083835b6020831015156108bd5780518252602082019150602081019050602083039250610898565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561093a57602002820191906000526020600020905b815481526020019060010190808311610926575b50505050509150600a6040519080825280602002602001820160405280156109715781602001602082028038833980820191505090505b509250600090505b81518110156109e257600a8110156109d557600080838381518110151561099c57fe5b9060200190602002015181526020019081526020016000206004015483828151811015156109c657fe5b90602001906020020181815250505b8080600101915050610979565b8292505050919050565b600060606000806109fb612ab8565b6000808781526020019081526020016000206005015491506000821415610a4257600080819150602060405190810160405280600081525090809050945094509450610c97565b60008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610af95780601f10610ace57610100808354040283529160200191610af9565b820191906000526020600020905b815481529060010190602001808311610adc57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b9b5780601f10610b7057610100808354040283529160200191610b9b565b820191906000526020600020905b815481529060010190602001808311610b7e57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c3d5780601f10610c1257610100808354040283529160200191610c3d565b820191906000526020600020905b815481529060010190602001808311610c2057829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905060008160c001511415610c96578181604001518260800151819150945094509450610c97565b5b50509193909250565b6000806002836040518082805190602001908083835b602083101515610cdb5780518252602082019150602081019050602083039250610cb6565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001546002846040518082805190602001908083835b602083101515610d4a5780518252602082019150602081019050602083039250610d25565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015491509150915091565b6040805190810160405280838152602001828152506002846040518082805190602001908083835b602083101515610dd75780518252602082019150602081019050602083039250610db2565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000015560208201518160010155905050505050565b6000610e30612ab8565b600080600086815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ee95780601f10610ebe57610100808354040283529160200191610ee9565b820191906000526020600020905b815481529060010190602001808311610ecc57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f8b5780601f10610f6057610100808354040283529160200191610f8b565b820191906000526020600020905b815481529060010190602001808311610f6e57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561102d5780601f106110025761010080835404028352916020019161102d565b820191906000526020600020905b81548152906001019060200180831161101057829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509150836040516020018082805190602001908083835b6020831015156110995780518252602082019150602081019050602083039250611074565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561110257805182526020820191506020810190506020830392506110dd565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191682600001516040516020018082805190602001908083835b602083101515611170578051825260208201915060208101905060208303925061114b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156111d957805182526020820191506020810190506020830392506111b4565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614151561121a5760009250611332565b6000806000878152602001908152602001600020600601541415156112425760009250611332565b60016000808781526020019081526020016000206006018190555060008086815260200190815260200160002060050154905061132d85826000808981526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113235780601f106112f857610100808354040283529160200191611323565b820191906000526020600020905b81548152906001019060200180831161130657829003601f168201915b5050505050611c28565b600192505b505092915050565b60006060600080600061134b612ab8565b6113578b8a8a8a611fd1565b92506000831415611388576000808191506020604051908101604052806000815250908090509550955095506118ce565b60008084815260200190815260200160002060000160405160200180828054600181600116156101000203166002900480156113fb5780601f106113d95761010080835404028352918201916113fb565b820191906000526020600020905b8154815290600101906020018083116113e7575b50509150506040516020818303038152906040526040518082805190602001908083835b602083101515611444578051825260208201915060208101905060208303925061141f565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019168a6040516020018082805190602001908083835b6020831015156114ae5780518252602082019150602081019050602083039250611489565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561151757805182526020820191506020810190506020830392506114f2565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614801561156b575060008060008581526020019081526020016000206005015414155b15611643578260008085815260200190815260200160002060020160008086815260200190815260200160002060040154818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116315780601f1061160657610100808354040283529160200191611631565b820191906000526020600020905b81548152906001019060200180831161161457829003601f168201915b505050505091509550955095506118ce565b6000808481526020019081526020016000206005015491506000821415156118ac5760008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561171c5780601f106116f15761010080835404028352916020019161171c565b820191906000526020600020905b8154815290600101906020018083116116ff57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156117be5780601f10611793576101008083540402835291602001916117be565b820191906000526020600020905b8154815290600101906020018083116117a157829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156118605780601f1061183557610100808354040283529160200191611860565b820191906000526020600020905b81548152906001019060200180831161184357829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905081816040015182608001518191509550955095506118ce565b6000808191506020604051908101604052806000815250908090509550955095505b505050955095509592505050565b60006118e6612af6565b6000806118f1612ab8565b6118fa8a61269c565b9350600084602001511480611913575060008460000151145b156119215760009450611c1b565b6003600081546001019190508190555083600001518460200151870281151561194657fe5b0492506119538984612735565b915060e0604051908101604052808b81526020018981526020018881526020018781526020018481526020018381526020016000815250905080600080600354815260200190815260200160002060008201518160000190805190602001906119bd929190612b10565b5060208201518160010190805190602001906119da929190612b10565b5060408201518160020190805190602001906119f7929190612b10565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015590505060018a6040518082805190602001908083835b602083101515611a5b5780518252602082019150602081019050602083039250611a36565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206003549080600181540180825580915050906001820390600052602060002001600090919290919091505550600082141515611c1557600354600080848152602001908152602001600020600501819055506000808381526020019081526020016000206002016040518082805460018160011615610100020316600290048015611b505780601f10611b2e576101008083540402835291820191611b50565b820191906000526020600020905b815481529060010190602001808311611b3c575b50509150506040518091039020896040518082805190602001908083835b602083101515611b935780518252602082019150602081019050602083039250611b6e565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390207f8dc1d65f72533cd068186029d9193e6e49fca64e41f026c18a1317ac6bb0ee898460008087815260200190815260200160002060040154604051808381526020018281526020019250505060405180910390a35b60035494505b5050505095945050505050565b60606000806001846040518082805190602001908083835b602083101515611c655780518252602082019150602081019050602083039250611c40565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020018280548015611ce257602002820191906000526020600020905b815481526020019060010190808311611cce575b5050505050925082519150600090505b8251811015611d2b57858382815181101515611d0a57fe5b906020019060200201511415611d1e578091505b8080600101915050611cf2565b8251821015611ebf576001846040518082805190602001908083835b602083101515611d6c5780518252602082019150602081019050602083039250611d47565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001845103815481101515611db057fe5b90600052602060002001546001856040518082805190602001908083835b602083101515611df35780518252602082019150602081019050602083039250611dce565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902083815481101515611e3357fe5b9060005260206000205050506001846040518082805190602001908083835b602083101515611e775780518252602082019150602081019050602083039250611e52565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480919060019003611ebd9190612b90565b505b600160008088815260200190815260200160002060060154148015611ef95750600160008087815260200190815260200160002060060154145b15611fc95760008087815260200190815260200160002060008082016000611f219190612bbc565b600182016000611f319190612bbc565b600282016000611f419190612bbc565b6003820160009055600482016000905560058201600090556006820160009055505060008086815260200190815260200160002060008082016000611f869190612bbc565b600182016000611f969190612bbc565b600282016000611fa69190612bbc565b600382016000905560048201600090556005820160009055600682016000905550505b505050505050565b600060606000611fdf612ab8565b6001886040518082805190602001908083835b6020831015156120175780518252602082019150602081019050602083039250611ff2565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561209457602002820191906000526020600020905b815481526020019060010190808311612080575b50505050509250600091505b825182101561268c5760008084848151811015156120ba57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156121775780601f1061214c57610100808354040283529160200191612177565b820191906000526020600020905b81548152906001019060200180831161215a57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156122195780601f106121ee57610100808354040283529160200191612219565b820191906000526020600020905b8154815290600101906020018083116121fc57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156122bb5780601f10612290576101008083540402835291602001916122bb565b820191906000526020600020905b81548152906001019060200180831161229e57829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050866040516020018082805190602001908083835b6020831015156123275780518252602082019150602081019050602083039250612302565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515612390578051825260208201915060208101905060208303925061236b565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681602001516040516020018082805190602001908083835b6020831015156123fe57805182526020820191506020810190506020830392506123d9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156124675780518252602082019150602081019050602083039250612442565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614801561264c5750856040516020018082805190602001908083835b6020831015156124d957805182526020820191506020810190506020830392506124b4565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515612542578051825260208201915060208101905060208303925061251d565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681604001516040516020018082805190602001908083835b6020831015156125b0578051825260208201915060208101905060208303925061258b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561261957805182526020820191506020810190506020830392506125f4565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b801561265b5750848160600151145b1561267f57828281518110151561266e57fe5b906020019060200201519350612691565b81806001019250506120a0565b600093505b505050949350505050565b6126a4612af6565b6002826040518082805190602001908083835b6020831015156126dc57805182526020820191506020810190506020830392506126b7565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020604080519081016040529081600082015481526020016001820154815250509050919050565b600060606000612743612ab8565b6001866040518082805190602001908083835b60208310151561277b5780518252602082019150602081019050602083039250612756565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156127f857602002820191906000526020600020905b8154815260200190600101908083116127e4575b50505050509250600091505b8251821015612aaa57600080848481518110151561281e57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156128db5780601f106128b0576101008083540402835291602001916128db565b820191906000526020600020905b8154815290600101906020018083116128be57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561297d5780601f106129525761010080835404028352916020019161297d565b820191906000526020600020905b81548152906001019060200180831161296057829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612a1f5780601f106129f457610100808354040283529160200191612a1f565b820191906000526020600020905b815481529060010190602001808311612a0257829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050848160600151148015612a69575060008160a00151145b8015612a79575060008160c00151145b15612a9d578282815181101515612a8c57fe5b906020019060200201519350612aaf565b8180600101925050612804565b600093505b50505092915050565b60e060405190810160405280606081526020016060815260200160608152602001600081526020016000815260200160008152602001600081525090565b604080519081016040528060008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10612b5157805160ff1916838001178555612b7f565b82800160010185558215612b7f579182015b82811115612b7e578251825591602001919060010190612b63565b5b509050612b8c9190612c04565b5090565b815481835581811115612bb757818360005260206000209182019101612bb69190612c04565b5b505050565b50805460018160011615610100020316600290046000825580601f10612be25750612c01565b601f016020900490600052602060002090810190612c009190612c04565b5b50565b612c2691905b80821115612c22576000816000905550600101612c0a565b5090565b905600a165627a7a72305820e867f86f93f232f65d5ca5618d0cea5847f4baf6529cec193670cd48efd5e4f50029")
	state.SetCode(address, code)
	var definition = `[
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getAvailableAmountByPair",
		"outputs": [
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getMatchableAmount",
		"outputs": [
			{
				"name": "amounts",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "requestID",
				"type": "uint256"
			}
		],
		"name": "getUncompletedMatchingRequest",
		"outputs": [
			{
				"name": "matchedRequestID",
				"type": "uint256"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getRatePublic",
		"outputs": [
			{
				"name": "sale",
				"type": "uint256"
			},
			{
				"name": "receive",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			},
			{
				"name": "saleAmount",
				"type": "uint256"
			},
			{
				"name": "receiveAmount",
				"type": "uint256"
			}
		],
		"name": "addRate",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "requestID",
				"type": "uint256"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "completeRequest",
		"outputs": [
			{
				"name": "success",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "sourcePair",
				"type": "string"
			},
			{
				"name": "interestedPair",
				"type": "string"
			},
			{
				"name": "fromAddress",
				"type": "string"
			},
			{
				"name": "toAddress",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "getMatchingRequestInfo",
		"outputs": [
			{
				"name": "matchedRequestID",
				"type": "uint256"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "srcPair",
				"type": "string"
			},
			{
				"name": "destPair",
				"type": "string"
			},
			{
				"name": "srcAddress",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "matchRequest",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "pair",
				"type": "string"
			},
			{
				"indexed": true,
				"name": "addr",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "matchRequestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Release",
		"type": "event"
	}
]`
	abi, err := abi.JSON(strings.NewReader(definition))
	var gas uint64

	if err != nil {
		t.Fatal(err)
	}

	// Try to get non-set rate
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	rateResult, _, errCallRate := Call(address, getRateInput, &Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}
	err = abi.UnpackIntoInterface(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(0)) != 0 || rateStruct.Receive.Cmp(big.NewInt(0)) != 0 {
		t.Error("Error get value, expected 0, 0 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := Call(address, setRateInput, &Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	var decodeInput struct {
		Pair          string
		SaleAmount    *big.Int
		ReceiveAmount *big.Int
	}
	e := abi.UnpackIntoInterface(&decodeInput, "addRate", setRateInput[4:])
	if e != nil {
		t.Fatal(e)
	}
	rateResult, _, errCallRate = Call(address, getRateInput, &Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	// Call get rate for ETH-NEO again to check if we set it correctly
	err = abi.UnpackIntoInterface(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e2 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, gas, e3 = Call(address, setRateInput2, &Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}

	// Find available amount for NEO-ETH now, should be 0
	getAvailableInput, _ := abi.Pack("getAvailableAmountByPair", "NEO-ETH")
	availableResult, _, err := Call(address, getAvailableInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(0)) != 0 {
		t.Fatal("Expect available input is 0, got", big.NewInt(0).SetBytes(availableResult).String())
	}
	// Get rate for NEO-ETH
	getRateInput2, e4 := abi.Pack("getRatePublic", "NEO-ETH")
	if e4 != nil {
		t.Fatal(e4)
	}
	rateResult, _, errCallRate = Call(address, getRateInput2, &Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	err = abi.UnpackIntoInterface(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}

	if rateStruct.Sale.Cmp(big.NewInt(10)) != 0 || rateStruct.Receive.Cmp(big.NewInt(1)) != 0 {
		t.Error("Error get value, expected 10, 1 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Start matching 1 eth for 10 neo
	matchInput1, e5 := abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 := Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for recently added order
	getMatchingInput1, e5 := abi.Pack("getMatchingRequestInfo", "ETH-NEO", "ETH-NEO", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, gas, e6 := Call(address, getMatchingInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var decodedMatchResult struct {
		MatchedRequestID *big.Int `abi:"matchedRequestID"`
		DestAddress      string   `abi:"destAddress"`
		SendAmount       *big.Int `abi:"sendAmount"`
	}
	unpackErr := abi.UnpackIntoInterface(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect id 0, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "" {
		t.Error("Expect address '', got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect send amount 0, got ", decodedMatchResult.SendAmount.String())
	}

	getAvailableInput, _ = abi.Pack("getAvailableAmountByPair", "ETH-NEO")
	availableResult, _, err = Call(address, getAvailableInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(10)) != 0 {
		t.Fatal("Expect available input is 10, got", big.NewInt(0).SetBytes(availableResult).String())
	}

	// Match request sell 10 NEO for 1 ETH
	matchInput2, e5 := abi.Pack("matchRequest", "NEO-ETH", "ETH-NEO", "neosender2", "ethReceiver2", big.NewInt(10))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, _, e6 = Call(address, matchInput2, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for 1st added order
	// now should return info of 2nd order
	getMatchingInput1, e5 = abi.Pack("getMatchingRequestInfo", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = Call(address, getMatchingInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.UnpackIntoInterface(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect id 2, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "ethReceiver2" {
		t.Error("Expect address ethReceiver2, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect send amount 1, got ", decodedMatchResult.SendAmount.String())
	}

	// GetMatching of NEO-ETH matching from NEO side (2nd order)
	// now should return info of 2nd order itself, because it's matched
	getMatchingInput2, e5 := abi.Pack("getMatchingRequestInfo", "NEO-ETH", "NEO-ETH", "neosender2", "ethReceiver2", big.NewInt(10))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = Call(address, getMatchingInput2, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.UnpackIntoInterface(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect id 2, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "ethReceiver2" {
		t.Error("Expect address ethReceiver2, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect send amount 1, got ", decodedMatchResult.SendAmount.String())
	}

	// complete order 1
	completeInput1, e7 := abi.Pack("completeRequest", big.NewInt(1), "ETH-NEO")
	if e7 != nil {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 := Call(address, completeInput1, &Config{State: state})
	if e8 != nil {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}

	// complete order 2
	completeInput1, e7 = abi.Pack("completeRequest", big.NewInt(2), "NEO-ETH")
	if e7 != nil {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 = Call(address, completeInput1, &Config{State: state})
	if e8 != nil {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}

	// Match 2 eth for 20 neo
	matchInput1, e5 = abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(2))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var matchableAmounts struct {
		Amounts []*big.Int `abi:"amounts"`
	}
	// get matchable amount for NEO, should be 20 NEO
	getMatchAmountsInput, _ := abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 := Call(address, getMatchAmountsInput, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.UnpackIntoInterface(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect 1st matchable amount to be 1, got ", matchableAmounts.Amounts[0].String())
	}

	// Match 3 other eth for 30 neo
	matchInput1, e5 = abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(3))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6, gas)
	}

	getMatchAmountsInput, _ = abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 = Call(address, getMatchAmountsInput, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.UnpackIntoInterface(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect 1st matchable amount to be 20, got ", matchableAmounts.Amounts[0].String())
	}
	if matchableAmounts.Amounts[1].Cmp(big.NewInt(30)) != 0 {
		t.Error("Expect 2nd matchable amount to be 20, got ", matchableAmounts.Amounts[0].String())
	}
	if matchableAmounts.Amounts[2].Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect 3rd matchable amount to be 0, got ", matchableAmounts.Amounts[0].String())
	}
}

func BenchmarkCall(b *testing.B) {
	var definition = `[{"constant":true,"inputs":[],"name":"seller","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"abort","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"value","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"refund","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"buyer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"confirmReceived","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[],"name":"confirmPurchase","outputs":[],"type":"function"},{"inputs":[],"type":"constructor"},{"anonymous":false,"inputs":[],"name":"Aborted","type":"event"},{"anonymous":false,"inputs":[],"name":"PurchaseConfirmed","type":"event"},{"anonymous":false,"inputs":[],"name":"ItemReceived","type":"event"},{"anonymous":false,"inputs":[],"name":"Refunded","type":"event"}]`

	var code = common.Hex2Bytes("6060604052361561006c5760e060020a600035046308551a53811461007457806335a063b4146100865780633fa4f245146100a6578063590e1ae3146100af5780637150d8ae146100cf57806373fac6f0146100e1578063c19d93fb146100fe578063d696069714610112575b610131610002565b610133600154600160a060020a031681565b610131600154600160a060020a0390811633919091161461015057610002565b61014660005481565b610131600154600160a060020a039081163391909116146102d557610002565b610133600254600160a060020a031681565b610131600254600160a060020a0333811691161461023757610002565b61014660025460ff60a060020a9091041681565b61013160025460009060ff60a060020a9091041681146101cc57610002565b005b600160a060020a03166060908152602090f35b6060908152602090f35b60025460009060a060020a900460ff16811461016b57610002565b600154600160a060020a03908116908290301631606082818181858883f150506002805460a060020a60ff02191660a160020a179055506040517f72c874aeff0b183a56e2b79c71b46e1aed4dee5e09862134b8821ba2fddbf8bf9250a150565b80546002023414806101dd57610002565b6002805460a060020a60ff021973ffffffffffffffffffffffffffffffffffffffff1990911633171660a060020a1790557fd5d55c8a68912e9a110618df8d5e2e83b8d83211c57a8ddd1203df92885dc881826060a15050565b60025460019060a060020a900460ff16811461025257610002565b60025460008054600160a060020a0390921691606082818181858883f150508354604051600160a060020a0391821694503090911631915082818181858883f150506002805460a060020a60ff02191660a160020a179055506040517fe89152acd703c9d8c7d28829d443260b411454d45394e7995815140c8cbcbcf79250a150565b60025460019060a060020a900460ff1681146102f057610002565b6002805460008054600160a060020a0390921692909102606082818181858883f150508354604051600160a060020a0391821694503090911631915082818181858883f150506002805460a060020a60ff02191660a160020a179055506040517f8616bbbbad963e4e65b1366f1d75dfb63f9e9704bbbf91fb01bec70849906cf79250a15056")

	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		b.Fatal(err)
	}

	cpurchase, err := abi.Pack("confirmPurchase")
	if err != nil {
		b.Fatal(err)
	}
	creceived, err := abi.Pack("confirmReceived")
	if err != nil {
		b.Fatal(err)
	}
	refund, err := abi.Pack("refund")
	if err != nil {
		b.Fatal(err)
	}

	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		for j := 0; j < 400; j++ {
			Execute(code, cpurchase, nil)
			Execute(code, creceived, nil)
			Execute(code, refund, nil)
		}
	}
}

func benchmarkKVM_Create(bench *testing.B, code string) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	var (
		sender   = common.BytesToAddress([]byte("sender"))
		receiver = common.BytesToAddress([]byte("receiver"))
	)

	state.CreateAccount(sender)
	state.SetCode(receiver, common.FromHex(code))
	runtimeConfig := Config{
		Origin:   sender,
		State:    state,
		GasLimit: 10000000,
		Time:     new(big.Int).SetUint64(0),
		Coinbase: common.Address{},
	}
	// Warm up the intpools and stuff
	bench.ResetTimer()
	for i := 0; i < bench.N; i++ {
		Call(receiver, []byte{}, &runtimeConfig)
	}
	bench.StopTimer()
}

func BenchmarkKVM_CREATE_500(bench *testing.B) {
	// initcode size 500K, repeatedly calls CREATE and then modifies the mem contents
	benchmarkKVM_Create(bench, "5b6207a120600080f0600152600056")
}
func BenchmarkKVM_CREATE2_500(bench *testing.B) {
	// initcode size 500K, repeatedly calls CREATE2 and then modifies the mem contents
	benchmarkKVM_Create(bench, "5b586207a120600080f5600152600056")
}
func BenchmarkKVM_CREATE_1200(bench *testing.B) {
	// initcode size 1200K, repeatedly calls CREATE and then modifies the mem contents
	benchmarkKVM_Create(bench, "5b62124f80600080f0600152600056")
}
func BenchmarkKVM_CREATE2_1200(bench *testing.B) {
	// initcode size 1200K, repeatedly calls CREATE2 and then modifies the mem contents
	benchmarkKVM_Create(bench, "5b5862124f80600080f5600152600056")
}

// benchmarkNonModifyingCode benchmarks code, but if the code modifies the
// state, this should not be used, since it does not reset the state between runs.
func benchmarkNonModifyingCode(gas uint64, code []byte, name string, b *testing.B) {
	cfg := new(Config)
	setDefaults(cfg)
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	cfg.State = state
	cfg.GasLimit = gas
	var (
		destination = common.BytesToAddress([]byte("contract"))
		kvmenv      = NewEnv(cfg)
		sender      = kvm.AccountRef(cfg.Origin)
	)
	state.CreateAccount(destination)
	eoa := common.HexToAddress("E0")
	{
		state.CreateAccount(eoa)
		state.SetNonce(eoa, 100)
	}
	reverting := common.HexToAddress("EE")
	{
		state.CreateAccount(reverting)
		state.SetCode(reverting, []byte{
			byte(kvm.PUSH1), 0x00,
			byte(kvm.PUSH1), 0x00,
			byte(kvm.REVERT),
		})
	}

	// state.CreateAccount(cfg.Origin)
	// set the receiver's (the executing contract) code for execution.
	state.SetCode(destination, code)
	kvmenv.Call(sender, destination, nil, gas, cfg.Value)

	b.Run(name, func(b *testing.B) {
		b.ReportAllocs()
		for i := 0; i < b.N; i++ {
			kvmenv.Call(sender, destination, nil, gas, cfg.Value)
		}
	})
}

// BenchmarkSimpleLoop test a pretty simple loop which loops until OOG
// 55 ms
func BenchmarkSimpleLoop(b *testing.B) {

	staticCallIdentity := []byte{
		byte(kvm.JUMPDEST), //  [ count ]
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),       // out offset
		byte(kvm.DUP1),       // out insize
		byte(kvm.DUP1),       // in offset
		byte(kvm.PUSH1), 0x4, // address of identity
		byte(kvm.GAS), // gas
		byte(kvm.STATICCALL),
		byte(kvm.POP),      // pop return value
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	callIdentity := []byte{
		byte(kvm.JUMPDEST), //  [ count ]
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),       // out offset
		byte(kvm.DUP1),       // out insize
		byte(kvm.DUP1),       // in offset
		byte(kvm.DUP1),       // value
		byte(kvm.PUSH1), 0x4, // address of identity
		byte(kvm.GAS), // gas
		byte(kvm.CALL),
		byte(kvm.POP),      // pop return value
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	callInexistant := []byte{
		byte(kvm.JUMPDEST), //  [ count ]
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),        // out offset
		byte(kvm.DUP1),        // out insize
		byte(kvm.DUP1),        // in offset
		byte(kvm.DUP1),        // value
		byte(kvm.PUSH1), 0xff, // address of existing contract
		byte(kvm.GAS), // gas
		byte(kvm.CALL),
		byte(kvm.POP),      // pop return value
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	callEOA := []byte{
		byte(kvm.JUMPDEST), //  [ count ]
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),        // out offset
		byte(kvm.DUP1),        // out insize
		byte(kvm.DUP1),        // in offset
		byte(kvm.DUP1),        // value
		byte(kvm.PUSH1), 0xE0, // address of EOA
		byte(kvm.GAS), // gas
		byte(kvm.CALL),
		byte(kvm.POP),      // pop return value
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	loopingCode := []byte{
		byte(kvm.JUMPDEST), //  [ count ]
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),       // out offset
		byte(kvm.DUP1),       // out insize
		byte(kvm.DUP1),       // in offset
		byte(kvm.PUSH1), 0x4, // address of identity
		byte(kvm.GAS), // gas

		byte(kvm.POP), byte(kvm.POP), byte(kvm.POP), byte(kvm.POP), byte(kvm.POP), byte(kvm.POP),
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	calllRevertingContractWithInput := []byte{
		byte(kvm.JUMPDEST), //
		// push args for the call
		byte(kvm.PUSH1), 0, // out size
		byte(kvm.DUP1),        // out offset
		byte(kvm.PUSH1), 0x20, // in size
		byte(kvm.PUSH1), 0x00, // in offset
		byte(kvm.PUSH1), 0x00, // value
		byte(kvm.PUSH1), 0xEE, // address of reverting contract
		byte(kvm.GAS), // gas
		byte(kvm.CALL),
		byte(kvm.POP),      // pop return value
		byte(kvm.PUSH1), 0, // jumpdestination
		byte(kvm.JUMP),
	}

	benchmarkNonModifyingCode(100000000, staticCallIdentity, "staticcall-identity-100M", b)
	benchmarkNonModifyingCode(100000000, callIdentity, "call-identity-100M", b)
	benchmarkNonModifyingCode(100000000, loopingCode, "loop-100M", b)
	benchmarkNonModifyingCode(100000000, callInexistant, "call-nonexist-100M", b)
	benchmarkNonModifyingCode(100000000, callEOA, "call-EOA-100M", b)
	benchmarkNonModifyingCode(100000000, calllRevertingContractWithInput, "call-reverting-100M", b)
}
