/*
 *  Copyright 2018 KardiaChain
 *  This file is part of the go-kardia library.
 *
 *  The go-kardia library is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  The go-kardia library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License
 *  along with the go-kardia library. If not, see <http://www.gnu.org/licenses/>.
 */

package kvm

import (
	"math/big"
	"strings"
	"testing"

	"github.com/kardiachain/go-kardia/kai/kaidb/memorydb"
	"github.com/kardiachain/go-kardia/kai/state"
	"github.com/kardiachain/go-kardia/kvm/sample_kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/log"
)

// Runtime_bytecode for ./Permission.sol
var permission_smc_code = common.Hex2Bytes("608060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302f0697b1461007d57806331e51ad414610174578063430ae633146101fb5780634665cb0714610278578063813775a3146102f5578063d1b7623c14610418575b600080fd5b34801561008957600080fd5b5061015e600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190929190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061056b565b6040518082815260200191505060405180910390f35b34801561018057600080fd5b506101e5600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506106dc565b6040518082815260200191505060405180910390f35b34801561020757600080fd5b50610262600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610811565b6040518082815260200191505060405180910390f35b34801561028457600080fd5b506102df600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610944565b6040518082815260200191505060405180910390f35b34801561030157600080fd5b5061035c600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610adf565b604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200184815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b838110156103da5780820151818401526020810190506103bf565b50505050905090810190601f1680156104075780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b34801561042457600080fd5b5061044360048036038101908080359060200190929190505050610e90565b60405180806020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001858152602001848152602001838103835288818151815260200191508051906020019080838360005b838110156104c55780820151818401526020810190506104aa565b50505050905090810190601f1680156104f25780820380516001836020036101000a031916815260200191505b50838103825286818151815260200191508051906020019080838360005b8381101561052b578082015181840152602081019050610510565b50505050905090810190601f1680156105585780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390f35b60006001151561057a33610f74565b151514151561058857600080fd5b60a0604051908101604052808673ffffffffffffffffffffffffffffffffffffffff168152602001848152602001858152602001600115158152602001838152506000876040518082805190602001908083835b60208310151561060157805182526020820191506020810190506020830392506105dc565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160040190805190602001906106cb9291906121eb565b509050506001905095945050505050565b60006106e88383611012565b156106f6576001905061080b565b600015156000846040518082805190602001908083835b602083101515610732578051825260208201915060208101905060208303925061070d565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff1615151415610787576000905061080b565b816000846040518082805190602001908083835b6020831015156107c0578051825260208201915060208101905060208303925061079b565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600201541415610806576001905061080b565b600090505b92915050565b600061081c82611045565b1561082a576001905061093f565b600015156000836040518082805190602001908083835b6020831015156108665780518252602082019150602081019050602083039250610841565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff16151514156108bb576000905061093f565b600080836040518082805190602001908083835b6020831015156108f457805182526020820191506020810190506020830392506108cf565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010154141561093a576000905061093f565b600190505b919050565b60006001151561095333610f74565b151514151561096157600080fd5b600a61096c83611070565b101561097b5760009050610ada565b600015156000836040518082805190602001908083835b6020831015156109b75780518252602082019150602081019050602083039250610992565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff1615151415610a0c5760009050610ada565b6000826040518082805190602001908083835b602083101515610a445780518252602082019150602081019050602083039250610a1f565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff0219169055600482016000610ad3919061226b565b5050600190505b919050565b600080600060606000610af186611070565b9050600a811015610b5457610b04611272565b81815181101515610b1157fe5b9060200190602002015160646001610b2761166f565b84815181101515610b3457fe5b906020019060200201518292508191508090509450945094509450610e88565b600015156000876040518082805190602001908083835b602083101515610b905780518252602082019150602081019050602083039250610b6b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff1615151415610c0857600080600082925081915080905060206040519081016040528060008152509450945094509450610e88565b6000866040518082805190602001908083835b602083101515610c405780518252602082019150602081019050602083039250610c1b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166000876040518082805190602001908083835b602083101515610ccf5780518252602082019150602081019050602083039250610caa565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600101546000886040518082805190602001908083835b602083101515610d3e5780518252602082019150602081019050602083039250610d19565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600201546000896040518082805190602001908083835b602083101515610dad5780518252602082019150602081019050602083039250610d88565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600401808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e785780601f10610e4d57610100808354040283529160200191610e78565b820191906000526020600020905b815481529060010190602001808311610e5b57829003601f168201915b5050505050905094509450945094505b509193509193565b6060600060606000806060600a87101515610ee957600080600060206040519081016040528060008152509291908292506020604051908101604052806000815250919081915080905095509550955095509550610f6a565b610ef16119e5565b90508087815181101515610f0157fe5b90602001906020020151610f13611272565b88815181101515610f2057fe5b90602001906020020151610f3261166f565b89815181101515610f3f57fe5b90602001906020020151610f516121d9565b610f596121e2565b849450829250955095509550955095505b5091939590929450565b600060606000610f82611272565b9150600082511415610f97576000925061100b565b600090505b8151811015611006578373ffffffffffffffffffffffffffffffffffffffff168282815181101515610fca57fe5b9060200190602002015173ffffffffffffffffffffffffffffffffffffffff161415610ff9576001925061100b565b8080600101915050610f9c565b600092505b5050919050565b6000600a61101f84611070565b10801561102c5750600182145b1561103a576001905061103f565b600090505b92915050565b60008061105183611070565b9050600a811015611065576001915061106a565b600091505b50919050565b60006060600061107e6119e5565b9150600090505b600a81101561126657818181518110151561109c57fe5b906020019060200201516040516020018082805190602001908083835b6020831015156110de57805182526020820191506020810190506020830392506110b9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156111475780518252602082019150602081019050602083039250611122565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916846040516020018082805190602001908083835b6020831015156111b1578051825260208201915060208101905060208303925061118c565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561121a57805182526020820191506020810190506020830392506111f5565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614156112595780925061126b565b8080600101915050611085565b600a92505b5050919050565b606080600a6040519080825280602002602001820160405280156112a55781602001602082028038833980820191505090505b50905073c1fe56e3f58d3244f606306611a5d10c8333f1f68160008151811015156112cc57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050737cefc13b6e2aedeedfb7cb6c32457240746baee581600181518110151561132c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073ff3dac4f04ddbd24de5d6039f90596f0a8bb08fd81600281518110151561138c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073071e8f5ddddd9f2d4b4bdf8fc970dfe8d9871c288160038151811015156113ec57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250507394fd535aab6c01302147be7819d07817647f7b6381600481518110151561144c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073a8073c95521a6db54f4b5ca31a04773b093e92748160058151811015156114ac57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073e94517a4f6f45e80cbaaffbb0b845f4c0fdd754781600681518110151561150c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073ba30505351c17f4c818d94a990eded95e166474b81600781518110151561156c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073212a83c0d7db5c526303f873d9ceaa32382b55d08160088151811015156115cc57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050738db7cf1823fcfa6e9e2063f983b3b96a48eed5a481600981518110151561162c57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508091505090565b606080600a6040519080825280602002602001820160405280156116a757816020015b60608152602001906001900390816116925790505b5090506040805190810160405280600981526020017f5b3a3a5d3a3330303000000000000000000000000000000000000000000000008152508160008151811015156116ef57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303031000000000000000000000000000000000000000000000081525081600181518110151561174157fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303032000000000000000000000000000000000000000000000081525081600281518110151561179357fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a3330303300000000000000000000000000000000000000000000008152508160038151811015156117e557fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303034000000000000000000000000000000000000000000000081525081600481518110151561183757fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303035000000000000000000000000000000000000000000000081525081600581518110151561188957fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a3330303600000000000000000000000000000000000000000000008152508160068151811015156118db57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303037000000000000000000000000000000000000000000000081525081600781518110151561192d57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a33303038000000000000000000000000000000000000000000000081525081600881518110151561197f57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a3330303900000000000000000000000000000000000000000000008152508160098151811015156119d157fe5b906020019060200201819052508091505090565b606080600a604051908082528060200260200182016040528015611a1d57816020015b6060815260200190600190039081611a085790505b50905060a060405190810160405280608081526020017f376138366532623736323863373666636165373661386233373032356362613681526020017f393861323839613434313032633563303231353934623563396663653333303781526020017f326565376566393932663565303138646334346239386661313166656335333881526020017f3234643739303135373437653861633437346634656531356237666265383630815250816000815181101515611ad857fe5b9060200190602002018190525060a060405190810160405280608081526020017f363630383839653339623337616465353866373839393333393534313233653581526020017f366436343938393836613063643963613633643232336538363664353532316181526020017f616564633965353239386532663438323861356339306634633538666232346581526020017f3139363133613436326361303231306464393632383231373934663633306630815250816001815181101515611b9d57fe5b9060200190602002018190525060a060405190810160405280608081526020017f326536316635373230316563383034663964353239386334363635383434666481526020017f303737613235313663643333656363656134386637626466393364653531383281526020017f646134663537646337623464383837306535653239316331373963303566663081526020017f3431303037313862343931383466363461376330643430636336363334336461815250816002815181101515611c6257fe5b9060200190602002018190525060a060405190810160405280608081526020017f666334316137316437613734643836363564626363306634386339613630316581526020017f333062373134656435303634373636396566353263303366373132336632616581526020017f303738646361613336333839653236333665313035356635663630666466333881526020017f6438396132323665653834323334663030366233333363616432643262636565815250816003815181101515611d2757fe5b9060200190602002018190525060a060405190810160405280608081526020017f656266343666616361373534666339303731366436363565366336666562323081526020017f366361343337633965356631363639306536393035313362333032393335303581526020017f336139643732326238386432616230623937326634363434386633613533333781526020017f3862663563666530316238333733616632653534313937623137363137653163815250816004815181101515611dec57fe5b9060200190602002018190525060a060405190810160405280608081526020017f383063346662663635313232643831376433383038616663623638336663363681526020017f643966396531396234373665613065653366373537646361356364313833313681526020017f656362383939396266656134653961356163633939363835303463623931393981526020017f3937613563316162363233633563353333636236363232393131343962306133815250816005815181101515611eb157fe5b9060200190602002018190525060a060405190810160405280608081526020017f356437656438313331393136623130656135343561353539616265343634333081526020017f373130396133643632646462653139633336383938386262646231646432333381526020017f306236663362626234373964306264643739656633363064376439313735303081526020017f3864393066376435313132323936393231303739336538613735326365636436815250816006815181101515611f7657fe5b9060200190602002018190525060a060405190810160405280608081526020017f376563643465613162663465666133346461633431613136643763636431346581526020017f323364333939336464336630613534643732326565373664313730373138616481526020017f626137663234366330383262616461393232633837356666616161343631386581526020017f333037623638653434633238343764346634653362373637383834633032623781525081600781518110151561203b57fe5b9060200190602002018190525060a060405190810160405280608081526020017f343835376637393265663737396335313166366437363433663039393134303981526020017f663737653431313234636564313433383532313735333536343133313566356481526020017f633939323765373330316666643761666337616538303235363633653137663581526020017f393333303661646637643366666163376336616136323563323530646530643581525081600881518110151561210057fe5b9060200190602002018190525060a060405190810160405280608081526020017f616436376332353032666332373233663264636632356131343037343433383281526020017f656233653465353064376534646439313063343233663761613466653066626281526020017f636332323037643232656636656466343639646436666265613733656661386481526020017f38376234623837366130643665333836633465303062366135316332613366388152508160098151811015156121c557fe5b906020019060200201819052508091505090565b60006064905090565b60006001905090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061222c57805160ff191683800117855561225a565b8280016001018555821561225a579182015b8281111561225957825182559160200191906001019061223e565b5b50905061226791906122b3565b5090565b50805460018160011615610100020316600290046000825580601f1061229157506122b0565b601f0160209004906000526020600020908101906122af91906122b3565b5b50565b6122d591905b808211156122d15760008160009055506001016122b9565b5090565b905600a165627a7a723058205866c4e899b08c82cedd509d485190cb0d34bfe4ec3f2e7a740e7fcdd8766bf00029")
var permission_smc_definition = `[
	{
	    "constant": true,
	    "inputs": [
	        {
	            "name": "_pubkey",
	            "type": "string"
	        },
	        {
	            "name": "_nodeType",
	            "type": "uint256"
	        }
        ],
	    "name": "isValidNode",
	    "outputs": [
	        {
	            "name": "",
	            "type": "uint256"
	        }
        ],
        "payable": false,
        "stateMutability": "view",
	    "type": "function"
	},
	{
	    "constant": true,
	    "inputs": [
	        {
	            "name": "_pubkey",
	            "type": "string"
	        }
        ],
        "name": "isValidator",
        "outputs": [
            {
                "name": "",
	            "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
	},
    {
        "constant": true,
        "inputs": [
            {
                "name": "_pubkey",
                "type": "string"
            }
        ],
        "name": "getNodeInfo",
        "outputs": [
            {
                "name": "addr",
	            "type": "address"
            },
            {
                "name": "votingPower",
                "type": "uint256"
            },
            {
                "name": "nodeType",
                "type": "uint256"
            }, 
            {
                "name": "listenAddress",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
	{
	    "constant": false,
	    "inputs": [
	        {
	            "name": "_pubkey",
	            "type": "string"
	        },
	        {
	            "name": "_addr",
	            "type": "address"
	        },
	        {
	            "name": "_nodeType",
	            "type": "uint256"
	        },
	        {
	            "name": "_votingPower",
	            "type": "uint256"
	        },
	        {
	            "name": "listenAddress",
	            "type": "string"
	        }
        ],
        "name": "addNode",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
	    "payable": false,
	    "stateMutability": "nonpayable",
	    "type": "function"
	},
	{
	    "constant": false,
	    "inputs": [
	        {
	            "name": "_pubkey",
	            "type": "string"
	        }
        ],
        "name": "removeNode",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
	},
	{
	    "constant": true,
	    "inputs": [
	        {"name": "index",
	        "type": "uint256"}
        ],
        "name": "getInitialNodeByIndex",
        "outputs": [
            {
                "name": "publickey",
                "type": "string"
            },
            {
                "name": "addr",
                "type": "address"
            },
            {
                "name": "listenAddr",
                "type": "string"
            },
            {
                "name": "votingPower",
                "type": "uint256"
            },
            {
                "name": "nodeType",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "pure",
        "type": "function"
	}
]`

func TestExecutePermissionContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(memorydb.New()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, permission_smc_code)
	abi, err := abi.JSON(strings.NewReader(permission_smc_definition))
	if err != nil {
		t.Fatal(err)
	}

	addNodeInput, err := abi.Pack("addNode", "abcdefxyz",
		common.HexToAddress("0x00009"), big.NewInt(2), big.NewInt(0), "[::]:3009")
	// Add node from non-owner account, should return error
	addNodeResult, _, err := sample_kvm.Call(address, addNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xaa")})
	if err == nil {
		t.Error("Added from non owner, expect error but nil returned")
	}
	// Add node from owner account
	addNodeResult, _, err = sample_kvm.Call(address, addNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	if err != nil {
		t.Fatal(err)
	}
	result := big.NewInt(0).SetBytes(addNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect add node from owner returns 1, got", result.String())
	}
	// Verify newly added node type
	getNodeInput, err := abi.Pack("getNodeInfo", "abcdefxyz")
	if err != nil {
		t.Fatal(err)
	}
	getNodeResult, _, err := sample_kvm.Call(address, getNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	var nodeInfo struct {
		Addr          common.Address
		VotingPower   *big.Int
		NodeType      *big.Int
		ListenAddress string
	}

	err = abi.Unpack(&nodeInfo, "getNodeInfo", getNodeResult)
	if err != nil {
		t.Fatal(err)
	}
	if nodeInfo.Addr != common.HexToAddress("0x00009") {
		t.Error("Expect address 0x00009, got", nodeInfo.Addr.String())
	}
	if nodeInfo.VotingPower.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect voting power 0, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.NodeType.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect node type 2, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.ListenAddress != "[::]:3009" {
		t.Error("Expect node listen address [::]:3009, got", nodeInfo.ListenAddress)
	}
	// Test if newly added node is valid
	getValidNodeInput, err := abi.Pack("isValidNode", "abcdefxyz",
		big.NewInt(2))
	if err != nil {
		t.Fatal(err)
	}
	getValidNodeResult, _, err := sample_kvm.Call(address, getValidNodeInput, &sample_kvm.Config{State: state})
	result = big.NewInt(0).SetBytes(getValidNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidNode return 1, got", result.String())
	}

	// Test if an arbitrary node is valid
	getValidNodeInput, err = abi.Pack("isValidNode", "abcxyz",
		big.NewInt(2))
	if err != nil {
		t.Fatal(err)
	}
	getValidNodeResult, _, err = sample_kvm.Call(address, getValidNodeInput, &sample_kvm.Config{State: state})
	result = big.NewInt(0).SetBytes(getValidNodeResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect isValidNode return 0, got", result.String())
	}

	// Test if initial validator is correct
	getValidatorInput, err := abi.Pack("isValidator", "7a86e2b7628c76fcae76a8b37025cba698a289a44102c5c021594b5c9fce33072ee7ef992f5e018dc44b98fa11fec53824d79015747e8ac474f4ee15b7fbe860")
	getValidatorResult, _, err := sample_kvm.Call(address, getValidatorInput, &sample_kvm.Config{State: state})
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidator return 1, got", result.String())
	}

	// Test if arbitrary key is regconized as initial validator
	getValidatorInput, err = abi.Pack("isValidator", "arbitrarypubkey")
	getValidatorResult, _, err = sample_kvm.Call(address, getValidatorInput, &sample_kvm.Config{State: state})
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect isValidator return 0, got", result.String())
	}

	// Test remove node with non-owner user
	removeNodeInput, err := abi.Pack("removeNode", "abcdefxyz", big.NewInt(2))
	// remove node sample_kvm.Called by non-owner user, should return error
	_, _, err = sample_kvm.Call(address, removeNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xaa")})
	if err == nil {
		t.Error("Remove from non owner, expect error but nil returned")
	}

	// Test remove with owner user, remove an initial node, should return error
	removeNodeInput, err = abi.Pack("removeNode", "7a86e2b7628c76fcae76a8b37025cba698a289a44102c5c021594b5c9fce33072ee7ef992f5e018dc44b98fa11fec53824d79015747e8ac474f4ee15b7fbe860")
	removeResult, _, err := sample_kvm.Call(address, removeNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	result = big.NewInt(0).SetBytes(removeResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Remove initial account should return 0 but got", result.String())
	}

	// Remove newly added node with owner user, should success
	removeNodeInput, err = abi.Pack("removeNode", "abcdefxyz")
	removeResult, _, err = sample_kvm.Call(address, removeNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	result = big.NewInt(0).SetBytes(removeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Remove newly added account should return 1 but got", result.String())
	}

	// Get NodeInfo of removed node
	getNodeResult, _, err = sample_kvm.Call(address, getNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	err = abi.Unpack(&nodeInfo, "getNodeInfo", getNodeResult)
	if err != nil {
		t.Fatal(err)
	}
	if nodeInfo.Addr != common.HexToAddress("0x") {
		t.Error("Expect address 0x, got", nodeInfo.Addr.String())
	}
	if nodeInfo.VotingPower.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect voting power 0, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.NodeType.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect node type 0, got", nodeInfo.VotingPower.String())
	}

	if nodeInfo.ListenAddress != "" {
		t.Error("Expect node listen address empty, got", nodeInfo.ListenAddress)
	}

	// Add new validator from owner account
	addNodeInput, err = abi.Pack("addNode", "abcdefxyz",
		common.HexToAddress("0x00009"), big.NewInt(1), big.NewInt(100), "[::]:3009")
	addNodeResult, _, err = sample_kvm.Call(address, addNodeInput, &sample_kvm.Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	if err != nil {
		t.Fatal(err)
	}
	result = big.NewInt(0).SetBytes(addNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect add node from owner returns 1, got", result.String())
	}

	// Test if newly added node is validator
	getValidatorInput, err = abi.Pack("isValidator", "abcdefxyz")
	getValidatorResult, _, err = sample_kvm.Call(address, getValidatorInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidator return 1, got", result.String())
	}

	// Test get 1 initial node info
	getInitialNodeInput, err := abi.Pack("getInitialNodeByIndex", big.NewInt(0))
	if err != nil {
		t.Fatal(err)
	}
	getInitialNodeResult, _, err := sample_kvm.Call(address, getInitialNodeInput, &sample_kvm.Config{State: state})
	var initialNodeInfo struct {
		Publickey   string
		Addr        common.Address
		ListenAddr  string
		VotingPower *big.Int
		NodeType    *big.Int
	}
	err = abi.Unpack(&initialNodeInfo, "getInitialNodeByIndex", getInitialNodeResult)
	if err != nil {
		t.Fatal(err)
	}
	if initialNodeInfo.Publickey != "7a86e2b7628c76fcae76a8b37025cba698a289a44102c5c021594b5c9fce33072ee7ef992f5e018dc44b98fa11fec53824d79015747e8ac474f4ee15b7fbe860" {
		t.Error("Invalid pubkey:", initialNodeInfo.Publickey)
	}
	if initialNodeInfo.Addr.String() != "0xc1fe56E3F58D3244F606306611a5d10c8333f1f6" {
		t.Error("Invalid addres, expect 0xc1fe56E3F58D3244F606306611a5d10c8333f1f6, got ", initialNodeInfo.Addr.String())
	}
	if initialNodeInfo.ListenAddr != "[::]:3000" {
		t.Error("Invalid listen address, expect [::]:3000, got", initialNodeInfo.ListenAddr)
	}
	if big.NewInt(100).Cmp(initialNodeInfo.VotingPower) != 0 {
		t.Error("Invalid voting power, expect 100, got ", initialNodeInfo.VotingPower.String())
	}
	if big.NewInt(1).Cmp(initialNodeInfo.NodeType) != 0 {
		t.Error("Invalid node type, expect 0, got ", initialNodeInfo.NodeType.String())
	}
}
